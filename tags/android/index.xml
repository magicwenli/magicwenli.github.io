<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Android on Magical trees, take me home.</title><link>/tags/android/</link><description>Recent content in Android on Magical trees, take me home.</description><generator>Hugo</generator><language>zh</language><lastBuildDate>Tue, 10 Sep 2024 02:54:08 +0000</lastBuildDate><atom:link href="/tags/android/index.xml" rel="self" type="application/rss+xml"/><item><title>Android 抓包以及 mitmproxy</title><link>/posts/android-emulator-packet-capture-and-everything/</link><pubDate>Fri, 26 Nov 2021 02:37:41 +0800</pubDate><guid>/posts/android-emulator-packet-capture-and-everything/</guid><description>&lt;h2 id="最佳实践">最佳实践&lt;/h2>
&lt;blockquote>
&lt;p>经过一段时间的研究，又有了新的看法。&lt;/p>
&lt;/blockquote>
&lt;p>准备以下两种工具：&lt;/p>
&lt;ul>
&lt;li>mitmproxy&lt;/li>
&lt;li>Android Emulator(MuMu, BlueStack &amp;hellip;)&lt;/li>
&lt;/ul>
&lt;h3 id="mitmproxy">mitmproxy&lt;/h3>
&lt;p>&lt;code>mitmproxy&lt;/code>最好使用&lt;a href="https://pypa.github.io/pipx/">pipx&lt;/a>安装。因为&lt;code>mitmproxy&lt;/code>运行在独立的&lt;code>venv&lt;/code>中，使用&lt;code>pipx&lt;/code>方便为&lt;code>mitmproxy&lt;/code>安装额外的python包。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>brew install pipx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>pipx install mitmproxy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>最好按照提示说明，使用&lt;code>pipx ensurepath&lt;/code>修改环境变量。&lt;/p>
&lt;p>这样我们就可以为&lt;code>mitmproxy&lt;/code>安装额外的python包了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>pipx inject mitmproxy pycryptodome &lt;span style="color:#228b22"># 安装 pycryptodome 包，用于AES解码&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>将浏览器代理设置到&lt;code>8080&lt;/code>端口，打开(mitm.it)[mitm.it]下载对应平台的证书。&lt;/p>
&lt;h3 id="android-emulator">Android Emulator&lt;/h3>
&lt;p>抓包之前有两个步骤：&lt;/p>
&lt;ol>
&lt;li>设置手动代理&lt;/li>
&lt;li>安装并信任自签名https证书&lt;/li>
&lt;/ol>
&lt;p>设置WiFi代理为主机&lt;code>8080&lt;/code>端口：&lt;/p>
&lt;p>&lt;img src="/img/Snipaste_2021-11-26_01-17-55.png" alt="Snipaste_2021-11-26_01-12-38">&lt;/p>
&lt;p>以下是简化的脚本&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>，先看看&lt;code>adb devices&lt;/code>信息，是否已经连接。如果没有成功连接需要&lt;code>adb kill-server&lt;/code>，再重试几次。或者参照后文&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>。
直接运行以下脚本&lt;code>./push.sh YOUR_CRT.crt&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00688b">PEM_FILE_NAME&lt;/span>=&lt;span style="color:#00688b">$1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;&lt;/span>&lt;span style="color:#00688b">$PEM_FILE_NAME&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00688b">hash&lt;/span>=&lt;span style="color:#8b008b;font-weight:bold">$(&lt;/span>openssl x509 -inform PEM -subject_hash_old -in &lt;span style="color:#00688b">$PEM_FILE_NAME&lt;/span> | head -1&lt;span style="color:#8b008b;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00688b">OUT_FILE_NAME&lt;/span>=&lt;span style="color:#cd5555">&amp;#34;&lt;/span>&lt;span style="color:#00688b">$hash&lt;/span>&lt;span style="color:#cd5555">.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cp &lt;span style="color:#00688b">$PEM_FILE_NAME&lt;/span> &lt;span style="color:#00688b">$OUT_FILE_NAME&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>openssl x509 -inform PEM -text -in &lt;span style="color:#00688b">$PEM_FILE_NAME&lt;/span> -out /dev/null &amp;gt;&amp;gt; &lt;span style="color:#00688b">$OUT_FILE_NAME&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;Saved to &lt;/span>&lt;span style="color:#00688b">$OUT_FILE_NAME&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>adb shell mount -o rw,remount,rw /system
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>adb push &lt;span style="color:#00688b">$OUT_FILE_NAME&lt;/span> /system/etc/security/cacerts/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>adb shell mount -o ro,remount,ro /system
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>adb reboot
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果模拟器正常重启的话应该就可以了。&lt;/p></description></item></channel></rss>