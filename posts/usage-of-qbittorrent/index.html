<!doctype html><html lang=en class=han-la><head><title>qBittorrent 的一些事儿 :: Great Expectations</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="有时会遇到种子掉线的问题，虽然出现的频率很低，但每次出现都让人困恼不已。"><meta name=keywords content=","><meta name=robots content="noodp"><link rel=canonical href=/posts/usage-of-qbittorrent/><link rel=stylesheet href=/assets/style.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:site content><meta name=twitter:creator content="Magicewenli"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="qBittorrent 的一些事儿"><meta property="og:description" content="有时会遇到种子掉线的问题，虽然出现的频率很低，但每次出现都让人困恼不已。"><meta property="og:url" content="/posts/usage-of-qbittorrent/"><meta property="og:site_name" content="Great Expectations"><meta property="og:image" content="/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-04-22 00:00:00 +0800 +0800"><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js></script>
<script type=text/javascript src=https://cdn.jsdelivr.net/gh/mastermay/text-autospace.js/text-autospace.min.js></script><style>html.han-la hanla:after{content:" ";display:inline;font-family:Arial;font-size:.89em}html.han-la code hanla,html.han-la pre hanla,html.han-la kbd hanla,html.han-la samp hanla{display:none}html.han-la ol>hanla,html.han-la ul>hanla{display:none}</style><link href=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.13.13/katex.min.css rel=stylesheet><script src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.13.13/katex.min.js></script>
<script defer src=https://cdn.bootcdn.net/ajax/libs/KaTeX/0.13.13/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></head><body class=orange><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Magicwenli $</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=https://github.com/magicwenli>Github</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=https://github.com/magicwenli>Github</a></li></ul></nav></header><div class=content><div style=min-width:100%><div class=post><h1 class=post-title><a href=/posts/usage-of-qbittorrent/>qBittorrent 的一些事儿</a></h1><div class=post-meta><span class=post-date>2022-04-22
[Updated: 2022-04-22]</span>
<span class=post-author>:: Magicewenli</span>
<span class=post-reading-time>:: 3 min read (1432 words)</span></div><span class=post-tags>#<a href=/tags/qbittorrent/>qBittorrent</a>&nbsp;
#<a href=/tags/pt/>PT</a>&nbsp;</span><div class=post-content><div><h2 id=introduction>Introduction<a href=#introduction class=hanchor arialabel=Anchor>&#8983;</a></h2><p>大学4年即将结束，回想这段时间。有时一个机缘巧合，我们就会被吸引并走进一个新的世界。PT就是我在大一期间认识到的，这种Freeeee的感觉太好了。后来组了自己的NAS，装入大容量硬盘，开启我的下载做种之路。</p><p>有时会遇到种子掉线的问题，虽然出现的频率很低，但每次出现都让人困恼不已。具体情况是因为torrent下载工具和NAS不在同一个设备上，每当突然掉电后，恢复启动的torrent下载工具无法确定种子进度，于是种子进度干脆显示成0%。要想恢复做种进度，需要对所有种子重新进行散列检测。</p><p>对于数以TB的文件，重新检测不仅需要大量的时间，而且会消耗大量的硬盘写入量，这对无论哪种硬盘都是一个灾难。</p><p>之前开发过qBittorrent和uTorrent的备份工具，没有达到预期效果。</p><p>今天看到了<a href=https://tomorrow505.xyz/%E5%9F%BA%E4%BA%8Eqbittorrentapi%E5%AE%9E%E7%8E%B0%E6%89%B9%E9%87%8F%E5%8A%A0%E8%BD%BD%E7%A7%8D%E5%AD%90%E8%B7%B3%E6%A3%80/>这篇文章</a>，感觉很有参考意义。本文就是在此基础上做的一点修改。</p><h2 id=qbittorrent-api>qbittorrent-api<a href=#qbittorrent-api class=hanchor arialabel=Anchor>&#8983;</a></h2><p><a href=https://github.com/rmartin16/qbittorrent-api>qbittorrent-api</a> 是qBittorrent Web API的Python实现。<a href=https://qbittorrent-api.readthedocs.io/en/latest/introduction.html>RTD</a></p><p>它支持qBittorrent v4.1.0+版本，基本实现了所有API。</p><p>支持的版本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> qbittorrentapi <span style=color:#f92672>import</span> Version
</span></span><span style=display:flex><span>versions <span style=color:#f92672>=</span> Version<span style=color:#f92672>.</span>supported_app_versions()
</span></span><span style=display:flex><span>print(sorted(versions))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># [&#39;v4.1.0&#39;, &#39;v4.1.1&#39;, &#39;v4.1.2&#39;, &#39;v4.1.3&#39;, &#39;v4.1.4&#39;, &#39;v4.1.5&#39;, &#39;v4.1.6&#39;, &#39;v4.1.7&#39;, &#39;v4.1.8&#39;, &#39;v4.1.9&#39;, &#39;v4.1.9.1&#39;, &#39;v4.2.0&#39;, &#39;v4.2.1&#39;, &#39;v4.2.2&#39;, &#39;v4.2.3&#39;, &#39;v4.2.4&#39;, &#39;v4.2.5&#39;, &#39;v4.3.0&#39;, &#39;v4.3.0.1&#39;, &#39;v4.3.1&#39;, &#39;v4.3.2&#39;, &#39;v4.3.3&#39;, &#39;v4.3.4.1&#39;, &#39;v4.3.5&#39;, &#39;v4.3.6&#39;, &#39;v4.3.7&#39;, &#39;v4.3.8&#39;, &#39;v4.3.9&#39;, &#39;v4.4.0&#39;, &#39;v4.4.1&#39;, &#39;v4.4.2&#39;]</span>
</span></span></code></pre></div><p>qBittorrent有许多版本，有些版本API变化很大。<a href=https://github.com/qbittorrent/qBittorrent/wiki#user-content-webui-api>官方WIKI</a>中将WebUI API划为三个版本。</p><table><thead><tr><th>State</th><th>Version</th></tr></thead><tbody><tr><td>Current</td><td>qBittorrent v4.1+</td></tr><tr><td>Previous</td><td>qBittorrent v3.2.0-v4.0.4</td></tr><tr><td>Obsolete</td><td>qBittorrent v3.1.x</td></tr></tbody></table><p>有一些PT站点限定使用<code>v3.*.*</code>版本，这样的话，就需要自己更新API了。</p><p>例如</p><ul><li><code>v3.*.*</code>的login接口为 <code>http://localhost:8080/login</code></li><li><code>v4.1.*</code>的login接口为<code>http://localhost:8080/api/v2/auth/login</code></li></ul><p>要寻找合适的版本，参考PT站的常见问题和<a href=https://sourceforge.net/projects/qbittorrent/files/qbittorrent-win32/>sourceforge</a>.</p><h2 id=skip-hash-detection>Skip hash detection<a href=#skip-hash-detection class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=bug-fix>Bug fix<a href=#bug-fix class=hanchor arialabel=Anchor>&#8983;</a></h3><p>根据<a href=https://github.com/7sDream/torrent_parser/issues/11>torrent_parser issue#11</a>, torrent_parser.py#L46</p><pre tabindex=0><code>from typing_extensions import OrderedDict
</code></pre><p>是误加入，应该手动删除。</p><p><code>BitTorrent</code>fastresume文件的解析包<code>bencode</code>似乎不支持python3了，这里使用<code>bencodepy</code>作为替代。</p><h3 id=full-code>Full code<a href=#full-code class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=collapsable-code><input id=1 type=checkbox checked>
<label for=1><span class=collapsable-code__language>python</span>
<span class=collapsable-code__title>qb-skip.py</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-python><code>
from qbittorrentapi import Client, LoginFailed
import torrent_parser as tp
from yaml import load
import os
import hashlib
import bencodepy
try:
    from yaml import CLoader as Loader
except ImportError:
    from yaml import Loader

def get_qb(config):
    # 获取客户端实例
    qb = Client(host=&#39;%s:%s&#39; % (config[&#39;ip&#39;], config[&#39;port&#39;]), username=config[&#39;user&#39;], password=config[&#39;pwd&#39;])

    # 客户端进行登录
    try:
        qb.auth_log_in()
    except LoginFailed as e:
        print(e)

    # 输出客户端信息
    print(f&#39;qBittorrent: {qb.app.version}&#39;)
    print(f&#39;qBittorrent Web API: {qb.app.web_api_version}&#39;)
    print()
    return qb


# 根据种子路径获取其hash值
def get_hash(filename):
    with open(filename, &#39;rb&#39;) as f:
        torrent_data = f.read()
        metainfo = bencodepy.decode(torrent_data)
        info = metainfo[b&#39;info&#39;]
        return hashlib.sha1(bencodepy.encode(info)).hexdigest()


# 加载配置文件
def load_config():
    data = load(open(&#39;./config.yml&#39;, &#39;rb&#39;), Loader=Loader)
    return data


# 获取种子文件列表信息
def pars_torrent(path):
    file_paths = []
    data = tp.parse_torrent_file(path)
    info = dict(data[&#39;info&#39;])
    if &#39;files&#39; in info.keys():
        for item in info[&#39;files&#39;]:
            file_paths.append(info[&#39;name&#39;] &#43; &#39;\\&#39; &#43; &#39;\\&#39;.join(item[&#39;path&#39;]))
    else:
        file_paths.append(info[&#39;name&#39;])
    return file_paths

# 主程序入口
if __name__ == &#39;__main__&#39;:
    user_info = load_config()
    qb = get_qb(user_info[&#39;qb&#39;])
    save_paths = user_info[&#39;save_path&#39;]
    
    # 输入种子所在目录
    torrents_path = input(&#34;请输入种子保存路径&gt;&gt;&#34;)
    files = os.listdir(torrents_path)
    
    # 循环处理种子信息
    for file in files:
        if not file.endswith(&#39;.torrent&#39;):
            continue
        print(&#34;*********************** 当前处理种子文件：%s ***********************&#34; % file)
        torrent_path = os.path.join(torrents_path, file)
        
        # 种子已经存在于客户端，跳过
        hash_value = get_hash(torrent_path)
        torrent = qb.torrents_info(torrent_hashes=hash_value)
        if len(torrent) == 1:
            print(&#34;当前种子已经存在于客户端，跳出……&#34;)
            continue
        
        # 判断种子文件是否存在于常用的保存路径
        torrent_files = pars_torrent(torrent_path)
        print(&#39;种子文件包含%d个文件&#39;%len(torrent_files))
        for save_path in save_paths:
            flag = True
            for torrent_file in torrent_files:
                if not os.path.isfile(os.path.join(save_path, torrent_file)):
                    print(&#39;%s 文件不存在，跳出……&#39; % os.path.join(save_path, torrent_file))
                    flag = False
                    break
            if flag == True:
                qb.torrents_add(torrent_files=torrent_path, save_path=save_path, is_skip_checking=True, is_paused=True)
                print(&#39;种子检验完毕，保存路径为%s，已经添加！！&#39; % save_path)
</code></pre></div><pre tabindex=0><code># result
qBittorrent: v4.1.4
qBittorrent Web API: 2.1.1

*********************** 当前处理种子文件：Severance.S01.1080p.ATVP.WEB-DL.DDP5.1.Atmos.H.264-TEPES.torrent ***********************
种子文件包含9个文件
种子检验完毕，保存路径为Y:\Transmission\DOWNLOADS，已经添加！！
</code></pre><div class=collapsable-code><input id=2 type=checkbox checked>
<label for=2><span class=collapsable-code__language>yaml</span>
<span class=collapsable-code__title>config.yml</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span></label><pre class=language-yaml><code>
qb:
  ip: &#39;192.168.123.189&#39;
  port: &#39;12345&#39;
  user: admin
  pwd: adminadmin
save_path:
    - Y:\Transmission\DOWNLOADS
</code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/emacs-style-keyboard-shortcut-of-macos/><span class=button__icon>←</span>
<span class=button__text>MacOS 的 Emacs 风格键盘快捷键</span></a></span>
<span class="button next"><a href=/posts/a-distant-cry-from-spring/><span class=button__text>《远山的呼唤》只是未到伤心处</span>
<span class=button__icon>→</span></a></span></div></div></div></div><aside class=aside-toc><div class=table-of-contents><h4>Contents</h4><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#qbittorrent-api>qbittorrent-api</a></li><li><a href=#skip-hash-detection>Skip hash detection</a><ul><li><a href=#bug-fix>Bug fix</a></li><li><a href=#full-code>Full code</a></li></ul></li></ul></nav></div></aside></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=/assets/main.js></script>
<script src=/assets/prism.js></script></div></body></html>